// source: https://github.com/facebook/react-native/pull/39520
// TODO remove in the future when this lands in RN

ext.resolveNodePackage = { String packageName, File startDir ->
    def candidate

    def osName = System.getProperty("os.name").toLowerCase()
    if (osName.contains("win")) {
        // for Windows OS
        candidate = new File(startDir, "node_modules\\$packageName")
    } else {
        // for Unix-likely OS (MacOS/Linux)
        candidate = new File(startDir, "node_modules/$packageName")
    }

    if (candidate.exists()) {
        // workaround for `candidate.canonicalPath` because it doesn't resolve final path to symlink on Windows
        return new File(candidate.toPath().toRealPath().toString())
    }

    def parentDir = startDir.parentFile
    if (parentDir == null || startDir.canonicalPath == parentDir.canonicalPath) {
        throw new GradleException("Failed to find the package '$packageName'. Ensure you have installed node_modules.")
    }

    return resolveNodePackage(packageName, parentDir)
}
